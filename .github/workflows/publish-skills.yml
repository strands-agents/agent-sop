name: Publish Skills to Claude Code Marketplace

on:
  push:
    branches: [ main ]
    paths:
      - 'agent-sops/**'
      - 'python/strands_agents_sops/**'
      - '.github/workflows/publish-skills.yml'
  workflow_dispatch:

jobs:
  publish-skills:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper branch management
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        cd python
        pip install -e .
        
    - name: Generate skills
      run: |
        # Create temporary directory for skill generation
        mkdir -p skills-dist
        
        # Generate skills using the CLI
        cd python
        python -m strands_agents_sops skills --output-dir ../skills-dist
        
    - name: Commit and push to skills-dist branch
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Check if skills-dist branch exists, create if not
        if git ls-remote --heads origin skills-dist; then
          # Branch exists, checkout and update
          git fetch origin skills-dist
          git checkout skills-dist
          git pull origin skills-dist
        else
          # Branch doesn't exist, create orphan branch
          git checkout --orphan skills-dist
          git rm -rf .
          touch .nojekyll  # For GitHub Pages
          echo "# Skills Distribution" > README.md
          echo "This branch contains auto-generated Claude Code skills from the main branch." >> README.md
          echo "" >> README.md
          echo "Generated from: https://github.com/strands-agents/agent-sop" >> README.md
          git add README.md .nojekyll
        fi
        
        # Copy generated skills, preserving the structure
        rm -rf skills/  # Remove existing skills if any
        cp -r ../skills-dist/* ./
        
        # Add all generated skills
        git add skills/
        git add README.md
        
        # Check if there are changes to commit
        if ! git diff-index --quiet HEAD; then
          git commit -m "chore: update generated skills

Auto-generated by GitHub Action
- Generated from: ${{ github.sha }}
- Triggered by: ${{ github.actor }}
- Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Push to skills-dist branch
          git push origin skills-dist
          echo "✅ Skills published to skills-dist branch"
        else
          echo "ℹ️ No changes to skills detected, skipping commit"
        fi
        
    - name: Update marketplace.json source reference
      run: |
        # Switch back to main branch
        git checkout main
        
        # Update marketplace.json to point to skills-dist branch
        if [ -f .claude-plugin/marketplace.json ]; then
          # Create updated marketplace.json with branch reference
          cat > .claude-plugin/marketplace.json << 'EOF'
{
  "name": "agent-sop",
  "owner": {
    "name": "Strands Agents", 
    "email": "strands-agents@amazon.com"
  },
  "metadata": {
    "description": "Natural language workflows (SOPs) for AI agents",
    "version": "1.0.0"
  },
  "plugins": [
    {
      "name": "agent-sops",
      "description": "All agent SOPs including code-assist, pdd, codebase-summary, code-task-generator, and eval",
      "source": "https://raw.githubusercontent.com/strands-agents/agent-sop/skills-dist/",
      "skills": [
        "./skills/code-assist",
        "./skills/codebase-summary", 
        "./skills/code-task-generator",
        "./skills/eval",
        "./skills/pdd"
      ]
    }
  ]
}
EOF
          
          # Add and commit the updated marketplace.json if changed
          if ! git diff --quiet .claude-plugin/marketplace.json; then
            git add .claude-plugin/marketplace.json
            git commit -m "ci: update marketplace source to skills-dist branch

- Updated plugin source to point to skills-dist branch
- Skills will be served from: https://raw.githubusercontent.com/strands-agents/agent-sop/skills-dist/

Auto-generated by GitHub Action"
            git push origin main
            echo "✅ Updated marketplace.json to use skills-dist branch"
          else
            echo "ℹ️ No changes to marketplace.json needed"
          fi
        fi