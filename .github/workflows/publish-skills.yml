name: Publish Skills to Claude Code Marketplace

on:
  release:
    types: [published]
  workflow_dispatch:

concurrency:
  group: publish-skills-dist
  cancel-in-progress: true

jobs:
  publish-skills:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ./python

      - name: Generate skills
        run: |
          rm -rf generated-skills
          python -m strands_agents_sops skills --output-dir generated-skills

      - name: Commit and push to skills-dist branch
        run: |
          set -euo pipefail

          # Save native skills from main before switching branches
          NATIVE_SKILLS_DIR=$(mktemp -d)
          if [ -d skills ]; then
            cp -R skills/* "$NATIVE_SKILLS_DIR/" 2>/dev/null || true
          fi

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if git ls-remote --heads origin skills-dist | grep -q skills-dist; then
            git fetch origin skills-dist
            git checkout -B skills-dist origin/skills-dist
          else
            git checkout --orphan skills-dist
            git rm -rf . || true
            touch .nojekyll
            printf '%s\n' '# Skills Distribution' '' 'This branch contains auto-generated Claude Code skills from the main branch.' '' 'Generated from: https://github.com/strands-agents/agent-sop' > README.md
          fi

          rm -rf skills
          mkdir -p skills

          # Copy generated skills (from SOPs)
          cp -R generated-skills/* skills/

          # Copy native skills (from skills/ on main), without overwriting generated ones
          cp -Rn "$NATIVE_SKILLS_DIR"/* skills/ 2>/dev/null || true
          rm -rf "$NATIVE_SKILLS_DIR"

          git add skills README.md .nojekyll

          if git diff --cached --quiet; then
            echo "ℹ️ No skill changes detected."
            exit 0
          fi

          git commit -m "chore: update generated skills
          
          Auto-generated by GitHub Action
          - Generated from: ${GITHUB_SHA}
          - Triggered by: ${GITHUB_ACTOR}
          - Workflow run: ${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

          git push origin skills-dist
          echo "✅ Skills published to skills-dist branch"
